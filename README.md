# Email Service

## Background
A web service which accepts email information and schedules and sends the email at specified time. This repository only contains a headless web server. Frontend is not included.

## Prerequisite
To run and build the application, please make sure npx is installed

```bash
npm install -g npx
```

## Generated Files
The project skeleton is generated by express-generator. The services implemented by me are mainly located in folder __services__. And all the test cases are located in folder __test__.

## Design
The scheduling is implemented using MongoDB and nodejs timer. For each task to be scheduled, it will be first inserted into the database and then only the tasks within a time window will be loaded into the in-memory timer. The reasons behind for this approach are listed below:

1. To be able to resume the scheduling after bringing down the application
2. No rapid database checking is needed (e.g. every second or every millisecond). Regular check is needed by the end of the time window.

Multiple instances can operate together to share workload with a shared MongoDB. The atomicity of document update prevent the processes from having duplicate scheduling. Horizontal scaling is feasible.

## Modules
1. MailService
    * Responsible for sending email. Multiple mail servers can be specified. Fail-over feature is implemented as required. SMTP protocol is used as it is common to all the mail servers.
2. TaskScheduler
    * Responsible for scheduling and emitting event at the specified time. No email sending logic is involved.
3. MailScheduler
    * The coordinator and orchestrator which leverages the features of MailService and TaskScheduler to schedule and send email.
    
## Configuration
All of the configurable properties can be specified in environment variables. It is for the ease of dockerize the application.
To run the application locally. You may prepare a __.env__ file and put it to the project directory. You may copy the below content and replace the mail server settings 

```dotenv
DEBUG=email-service:*

MAIL_SERVERS=[{"host":"","port":465,"secure":true,"auth":{"user":"","pass":""},"sender":""},{"host":"","port":465,"secure":true,"auth":{"user":"","pass":""},"sender":""}]

MONGODB_URL=mongodb://localhost:27017
MONGODB_DATABASE=EmailServiceDEV

LOGGER_LEVEL=trace

```
    
## Build and Run
 
### Run Locally
Prepare the .env file in project directory and execute npm start
 ```
npm install
npm start
``` 

### Docker
You may build the docker image with the Dockerfile in project directory.

## API
Only one HTTP POST endpoint is implemented for scheduling an email

method: POST
endpoint: /mails

```json
{
	"to": ["email"],
	"cc": ["email"],
	"bcc": ["email"],
	"subject": "Test from Web",
	"text": "This is a test email",
	"html": "HTML content",
	"timestamp": 1543659600000
}
```

## Discussion and TODO
1. The mail content is now loaded to memory when scheduling. If the content is large in size and hits the memory limit, we may consider to store the mail in persistence storage and use the only the ID as the event context. And the mail content is loaded only when the event is fired.
2. For the test cases, a running MongoDB is now required for testing. Embedded database or pre-test initialized DB would be better for isolation. Further investigation is needed.
3. Attachment supports
4. Multiple recipients are supported by the backend but not the dummy frontend.
5. HTML content is supported by the backend but not the dummy frontend.
6. As of limited time, only few critical test cases are implemented. More test cases are needed for testing edge cases.  
7. Swagger doc can be provided for the API
8. In the current design, tasks scheduled to in-memory timer are rolled back only when the server are gracefully shutdown. In case the server goes down explicitly, some records may remain in "SCHEDULED" status. A fix could be done is to have a cron job to check all the 'SCHEDULED' tasks and send alert when there are records pending for an unexpected long period of time.
9. Housekeeping. Archive or purge fired records.
10. Task manipulating API, e.g. editing and deleting unfired tasks.
